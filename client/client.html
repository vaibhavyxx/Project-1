<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 1</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
        const clearBookDetails = () => {
            const bookList = document.querySelectorAll('.bookContent'); 
            bookList.forEach(bookItem => {
                if(bookItem) bookItem.remove();
            });
        }

        const renderContentTypes = (response, content) => {
            content.innerText = `Response status: ${response.status}, Content Length: ${response.headers.get('content-length')}`;
        }

        const renderBookDetails = (content, book) =>{
            const bookContent = document.createElement('div');
            const bookDetails = document.createElement('div');
            bookContent.className = 'bookContent';
            bookDetails.className = 'bookDetailsTag';
            
            const titleLink = document.createElement('a');
            titleLink.href = book["link"];
            const linkText = document.createTextNode(book["title"]);
            bookDetails.innerHTML = `<ul><li>Author: ${book["author"]}</li>
                <li>Country: ${book["country"]}</li>
                <li>Pages: ${book["pages"]}</li>
                <li>Language: ${book["language"]}</li>
                Genres:`;

            const genres = book["genres"];
            for(genre in genres){
                bookDetails.innerHTML += `${genres[genre]}, `;
            }
            bookDetails.innerHTML += '</ul>';

            titleLink.appendChild(linkText);
            bookContent.appendChild(titleLink);
            bookContent.appendChild(bookDetails);
            content.appendChild(bookContent);
        }

        //test case but this code is a repeat 
        const handleTitleResponse = (response) => {
            response.text().then(resText => {
                const content = document.querySelector('#content');
                clearBookDetails();

                if(response.status === 200){
                    const data = JSON.parse(resText);

                    if(Object.keys(data).length ===0){
                        content.innerHTML = `<p>No book found</p>`;
                        return;
                    }
                    const count =  1;//Object.keys(data).length;
                    for(let i =0; i < count; i++){
                        renderBookDetails(content, data); //tests
                    }
                }
            });
        }

        const handleGetResponses = (response, type) => {
            response.text().then(resText => {
                const content = document.querySelector('#content');
                const responseContent = document.querySelector('#response');
                renderContentTypes(response, responseContent);
    
                if(response.status === 200 && type === 'GET'){
                    if(type === 'GET'){
                        let data = JSON.parse(resText);
                        for(book in data){
                            renderBookDetails(content, data[book]);
                    }
                    }else if(type === 'HEAD'){
                        clearBookDetails();
                    }
                }
            });
        }

        const handleResponses = async (response) => {
            const content = document.querySelector('#content');
            //console.log("status"+ response.status);
            let phrase = "";
            debugger;
            switch(response.status){
                case 200:
                    phrase="Success";
                    break;
                case 201:
                    phrase="Created";
                    break;
                case 204:
                    phrase="Updated";
                    break;
                case 400:
                    phrase="Bad Request";
                    break;
                default:
                    phrase="Not implemented";
                    break;
            }
            content.innerHTML = phrase;
            if(response.status !== 204){
                const obj = await response.json();
                if(obj.message){
                    content.innerHTML += `<p>${obj.message}</p>`
                }
            }
        };

        const sendFetchRequest = (url, acceptedType, type)=>{
            const options = {
                method:type,
                headers:{
                    'Accept':acceptedType,
                },
            };
            fetch(url, options)
                .then(data => {
                    if(url.includes('/getData')){
                        handleGetResponses(data, type);
                    }else{
                        handleTitleResponse(data)
                    }
                    //handleGetResponses(data, type);
                })
                .catch(err =>{
                    console.log('fetch error: '+ err);
                });
        }

        const sendPost = async (form, addData) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');
            const dataType = form.querySelector('#dataType').value;

            let data = {};
            let phrase = "";
            const title = form.querySelector("[name=title]").value;
            if(addData){
                const author = form.querySelector('[name=author]').value;
                const year = form.querySelector('[name=year]').value;
                const genres = form.querySelector('[name=genres]').value;
                data = {author, title, year, genres};
                phrase = `author=${author}&title=${title}&year=${year}&genres=${genres}`;
            }else{
                const pages = form.querySelector('[name=page]').value;
                const country = form.querySelector('[name=country]').value;
                data = {title, pages, country};
                phrase = `title=${title}&pages=${pages}&country=${country}`;
            }

            if(dataType === 'application/json'){
                phrase = JSON.stringify(data);
            }
            const response = await fetch(url, {
                method:'POST',
                headers:{
                    'Content-Type': dataType,
                    'Content-Length': form.length,
                    'Accept': 'application/json',   //test if this can be accepted as url-encoded
                },
                body: phrase,
            });
            handleResponses(response);
        }

    const init = () => {
        const addBookForm = document.querySelector('#addBookForm');
        const addDetailsForm = document.querySelector('#adminForm');
        const getAllForm = document.querySelector('#getAllForm');
        const clearButton = document.querySelector('#clear');
        const titleForm = document.querySelector('#filterTitleForm');

        const fetchData = (e) => {
            e.preventDefault();
            const method = getAllForm.querySelector('input[name="method"]:checked');
            if(!method){
                return; //No method selected
            }
            sendFetchRequest(getAllForm.getAttribute('action'), 'application/json',method.value);
            return false;
        }
        const addDetails = (e) => {
            e.preventDefault();
            sendPost(addDetailsForm, false);
            return false;
        }
        const addBookData = (e) => {
            e.preventDefault();
            sendPost(addBookForm, true);
            return false;
        }
        
        addBookForm.addEventListener('submit', addBookData);
        addDetailsForm.addEventListener('submit', addDetails);
        getAllForm.addEventListener('submit', fetchData);
        titleForm.addEventListener('submit', (e)=> {
            e.preventDefault();
            const title = titleForm.querySelector('[name=title]').value;
            let url = titleForm.getAttribute('action');
            url += `?title=${title}`;
            sendFetchRequest(url, 'application/json','GET');
        });

        clearButton.addEventListener('click', ()=> {
            clearBookDetails();
        });
    };
    window.onload = init;
    </script>
</head>
<body>
    <h1>Book's Directory</h1>

    <h3>Filter Titles</h3>
    <form id="filterTitleForm" action="/getTitles">
        <label for="title">Title</label>
        <input type="text" name="title">
        <input type="submit" value="Filter">
        <!--<section id="titleContent"></section>-->
    </form>
    
    <h3>Fetch Requests</h3>
    <form id="getAllForm" action="/getData">
        <label for="get">Get</label>
        <input type="radio" name="method" value="GET">

        <label for="head">Head</label>
        <input type="radio" name="method" value="HEAD">
        <input type="submit" value="Get JSON">
        <!--<section id="getDataContent"></section>-->
    </form>
    <button id="clear">clear</button>

    <h3>POST: Add a book</h3> 
    <form id="addBookForm" action="/addBook" method="post">
        <label for="author">Author: </label>
        <input id="authorField" type="text" name="author">

        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title">

        <label for="year">Year: </label>
        <input id="yearField" type="number" name="year">

        <label for="genres">Genres: </label>
        <input id="genresField" type="text" name="genres">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>

    <h3>POST: Add Admin Details</h3>
    <form id="adminForm" action="/addDetails" method="post">
        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title" >

        <label for="page">Pages: </label>
        <input id="pageField" type="number" min="1" name="page">

        <label for="country">Country: </label>
        <input id="countryField" type="text" name="country">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book">
    </form>

    <section id="response"></section>
    <section id="content"></section>
    <footer></footer>
</body>
</html>