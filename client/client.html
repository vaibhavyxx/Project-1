<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 1</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
        const handleResponses = async (response) => {
            const content = document.querySelector('#content');
            console.log("status"+ response.status);
            let phrase = "hi there";
            switch(response.status){
                case 200:
                    phrase="Success";
                    break;
                case 201:
                    phrase="Created";
                    break;
                case 204:
                    phrase="Updated";
                    break;
                case 400:
                    phrase="Bad Request";
                    break;
                default:
                    phrase="Not implemented";
                    break;
            }
            content.innerHTML = phrase;
            if(response.status !== 204){
                const obj = await response.json();
                if(obj.message){
                    content.innerHTML += `<p>${obj.message}</p>`
                }
            }
        };

        const sendPostBookData = async (form, addData) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');
            const dataType = form.querySelector('#dataType').value;

            let data = {};
            let phrase = "";
            const title = form.querySelector("[name=title]").value;
            if(addData){
                const author = form.querySelector('[name=author]').value;
                const year = form.querySelector('[name=year]').value;
                const genres = form.querySelector('[name=genres]').value;
                data = {author, title, year, genres};
                phrase = `author=${author}&title=${title}&year=${year}&genres=${genres}`;
            }else{
                const pages = form.querySelector('[name=page]').value;
                const country = form.querySelector('[name=country]').value;
                data = {title, pages, country};
                phrase = `title=${title}&pages=${pages}&country=${country}`;
            }

            if(dataType === 'application/json'){
                phrase = JSON.stringify(data);
            }
            const response = await fetch(url, {
                method:'POST',
                headers:{
                    'Content-Type': dataType,
                    'Content-Length': bookForm.length,
                    'Accept': 'application/json',   //test if this can be accepted as url-encoded
                },
                body: phrase,
            });
            handleResponses(response);
        }

        const sendPost = async (bookForm) => {
            const url = bookForm.getAttribute('action');
            const method = bookForm.getAttribute('method');
            const dataType = bookForm.querySelector('#dataType').value;

            const author = bookForm.querySelector('#authorField').value;
            const country = bookForm.querySelector('#countryField').value;
            const language = bookForm.querySelector('#languageField').value;
            const link = bookForm.querySelector('#linkField').value;
            const page = bookForm.querySelector('#pageField').value;
            const title = bookForm.querySelector('#titleField').value;
            const year = bookForm.querySelector('#yearField').value;
            const genres = bookForm.querySelector('#genresField').value;
        
            let formData = "";
            if(dataType === 'application/x-www-form-urlencoded'){
                formData = `author=${author}&country=${country}&language=${language}&link=${link}&page=${page}&title=${title}&year=${year}&genres=${genres}`;
            }else {
                formData = JSON.stringify({author, country, language, link, page, title, year, genres});
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers:{
                    'Content-Type': dataType,
                    'Content-Length': bookForm.length,
                    'Accept': 'application/json',
                },
                body: formData,
            });
            handleResponses(response);
        }

    const init = () => {
        const form = document.querySelector('#bookForm');
        const addBookForm = document.querySelector('#addBookForm');
        const addDetailsForm = document.querySelector('#adminForm');

        const addAllDeets = (e) => {
            e.preventDefault();
            sendPost(form);
            return false;
        }
        const addDetails = (e) => {
            e.preventDefault();
            sendPostBookData(addDetailsForm, false);
            return false;
        }
        const addBookData = (e) => {
            e.preventDefault();
            sendPostBookData(addBookForm, true);
            return false;
        }
        addBookForm.addEventListener('submit', addBookData);
        addDetailsForm.addEventListener('submit', addDetails);
        form.addEventListener('submit', addAllDeets);
    };
    window.onload = init;
    </script>
</head>
<body>
    <h1>Book's Directory</h1>

    <h3>Add a book</h3> 
    <form id="addBookForm" action="/addBook" method="post">
        <label for="author">Author: </label>
        <input id="authorField" type="text" name="author"/>

        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title"/>

        <label for="year">Year: </label>
        <input id="yearField" type="number" name="year"/>

        <label for="genres">Genres: </label>
        <input id="genresField" type="text" name="genres"/>

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>

    <h3>Add Admin Details</h3>
    <form id="adminForm" action="/addDetails" method="post">
        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title" >

        <label for="page">Pages: </label>
        <input id="pageField" type="number" min="1" name="page"/>

        <label for="country">Country: </label>
        <input id="countryField" type="text" name="country"/>

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>

    <section id="content"></section>
    <form id="bookForm" action="/addAllData" method="post">

        <label for="author">Author: </label>
        <input id="authorField" type="text" name="author" />
        
        <label for="country">Country: </label>
        <input id="countryField" type="text" name="country"/>
        
        <label for="language">Language: </label>
        <input id="languageField" type="text" name="language"/>

        <label for="link">Link: </label>
        <input id="linkField" type="text" name="link" />

        <label for="page">Page: </label>
        <input id="pageField" type="number" name="page" min="1" step="1">

        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title"/>

        <label for="year">Year: </label>
        <input id="yearField" type="number" name="year" step="1">

        <label for="genres">Genres: </label>
        <input id="genresField" type="text" name="genres"/>
        
        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>
    
</body>
</html>