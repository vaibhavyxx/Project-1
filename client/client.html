<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 1</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
        const handleResponses = async (response) => {
            const content = document.querySelector('#content');
            console.log("status"+ response.status);
            let phrase = "hi there";
            switch(response.status){
                case 200:
                    phrase="Success";
                    break;
                case 201:
                    phrase="Created";
                    break;
                case 204:
                    phrase="Updated";
                    break;
                case 400:
                    phrase="Bad Request";
                    break;
                default:
                    phrase="Not implemented";
                    break;
            }
            content.innerHTML = phrase;
            if(response.status !== 204){
                const obj = await response.json();
                if(obj.message){
                    content.innerHTML += `<p>${obj.message}</p>`
                }
            }
        };

        const sendPostBookData = async (form, addData) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');
            const dataType = form.querySelector('#dataType').value;

            let data = {};
            let phrase = "";
            const title = form.querySelector("[name=title]").value;
            if(addData){
                const author = form.querySelector('[name=author]').value;
                const year = form.querySelector('[name=year]').value;
                const genres = form.querySelector('[name=genres]').value;
                data = {author, title, year, genres};
                phrase = `author=${author}&title=${title}&year=${year}&genres=${genres}`;
            }else{
                const pages = form.querySelector('[name=page]').value;
                const country = form.querySelector('[name=country]').value;
                data = {title, pages, country};
                phrase = `title=${title}&pages=${pages}&country=${country}`;
            }

            if(dataType === 'application/json'){
                phrase = JSON.stringify(data);
                //console.log(phrase);
            }
            const response = await fetch(url, {
                method:'POST',
                headers:{
                    'Content-Type': dataType,
                    'Content-Length': form.length,
                    'Accept': 'application/json',   //test if this can be accepted as url-encoded
                },
                body: phrase,
            });
            handleResponses(response);
        }

    const init = () => {
        const addBookForm = document.querySelector('#addBookForm');
        const addDetailsForm = document.querySelector('#adminForm');

        const addDetails = (e) => {
            e.preventDefault();
            sendPostBookData(addDetailsForm, false);
            return false;
        }
        const addBookData = (e) => {
            e.preventDefault();
            sendPostBookData(addBookForm, true);
            return false;
        }
        addBookForm.addEventListener('submit', addBookData);
        addDetailsForm.addEventListener('submit', addDetails);
    };
    window.onload = init;
    </script>
</head>
<body>
    <h1>Book's Directory</h1>

    <h3>Fetch Requests</h3>
    <form id="getAllForm" action="/data">
        <label for="get">Get</label>
        <input type="radio" name="get">
        <label for="head">Head</label>
        <input type="radio" name="head">
        <input type="submit" value="Get JSON">
    </form>

    <h3>POST: Add a book</h3> 
    <form id="addBookForm" action="/addBook" method="post">
        <label for="author">Author: </label>
        <input id="authorField" type="text" name="author">

        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title">

        <label for="year">Year: </label>
        <input id="yearField" type="number" name="year">

        <label for="genres">Genres: </label>
        <input id="genresField" type="text" name="genres">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>

    <h3>POST: Add Admin Details</h3>
    <form id="adminForm" action="/addDetails" method="post">
        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title" >

        <label for="page">Pages: </label>
        <input id="pageField" type="number" min="1" name="page">

        <label for="country">Country: </label>
        <input id="countryField" type="text" name="country">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book">
    </form>

    <section id="content"></section>
    
</body>
</html>