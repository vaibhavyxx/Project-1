<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 1</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
        const handleGetResponses = (response) => {
            response.text().then(resText => {
                if(response.status === 200){
                    //console.log(JSON.parse(resText));
                    const content = document.querySelector('#getDataContent');
                    const rawData = document.createElement('p');
                    const h2 = document.createElement('h2');
                    let data = JSON.parse(resText);

                    for(book in data){
                        const bookData = data[book];
                        rawData.innerText +=  `author: ${bookData["author"]}, title: ${bookData["title"]}, country: ${bookData["country"]}, 
                        language: ${bookData["language"]}, link: ${bookData["link"]}, pages: ${bookData["pages"]}, genres: `;
                        const genresArray = bookData["genres"];
                        for(genre in genresArray){
                            rawData.innerText += genresArray[genre];
                        }
                    }
                    content.appendChild(rawData);
                }
            });
        }

        const handleResponses = async (response) => {
            const content = document.querySelector('#content');
            console.log("status"+ response.status);
            let phrase = "";
            debugger;
            switch(response.status){
                case 200:
                    phrase="Success";
                    break;
                case 201:
                    phrase="Created";
                    break;
                case 204:
                    phrase="Updated";
                    break;
                case 400:
                    phrase="Bad Request";
                    break;
                default:
                    phrase="Not implemented";
                    break;
            }
            content.innerHTML = phrase;
            if(response.status !== 204){
                const obj = await response.json();
                if(obj.message){
                    content.innerHTML += `<p>${obj.message}</p>`
                }
            }
        };

        const sendFetchRequest = (url, acceptedType, type)=>{
            const options = {
                method:type,
                headers:{
                    'Accept':acceptedType,
                },
            };
            console.log(url +"called get function");
            fetch(url, options)
                .then(data => {
                    handleGetResponses(data);
                })
                .catch(err =>{
                    console.log('fetch error: '+ err);
                });
        }

        const sendPost = async (form, addData) => {
            const url = form.getAttribute('action');
            const method = form.getAttribute('method');
            const dataType = form.querySelector('#dataType').value;

            let data = {};
            let phrase = "";
            const title = form.querySelector("[name=title]").value;
            if(addData){
                const author = form.querySelector('[name=author]').value;
                const year = form.querySelector('[name=year]').value;
                const genres = form.querySelector('[name=genres]').value;
                data = {author, title, year, genres};
                phrase = `author=${author}&title=${title}&year=${year}&genres=${genres}`;
            }else{
                const pages = form.querySelector('[name=page]').value;
                const country = form.querySelector('[name=country]').value;
                data = {title, pages, country};
                phrase = `title=${title}&pages=${pages}&country=${country}`;
            }

            if(dataType === 'application/json'){
                phrase = JSON.stringify(data);
            }
            const response = await fetch(url, {
                method:'POST',
                headers:{
                    'Content-Type': dataType,
                    'Content-Length': form.length,
                    'Accept': 'application/json',   //test if this can be accepted as url-encoded
                },
                body: phrase,
            });
            handleResponses(response);
        }

    const init = () => {
        const addBookForm = document.querySelector('#addBookForm');
        const addDetailsForm = document.querySelector('#adminForm');
        const getAllForm = document.querySelector('#getAllForm');

        const fetchData = (e) => {
            e.preventDefault();
            sendFetchRequest(getAllForm.getAttribute('action'), 'application/json','GET');
            return false;
        }
        const addDetails = (e) => {
            e.preventDefault();
            sendPost(addDetailsForm, false);
            return false;
        }
        const addBookData = (e) => {
            e.preventDefault();
            sendPost(addBookForm, true);
            return false;
        }
        addBookForm.addEventListener('submit', addBookData);
        addDetailsForm.addEventListener('submit', addDetails);
        getAllForm.addEventListener('submit', fetchData);
    };
    window.onload = init;
    </script>
</head>
<body>
    <h1>Book's Directory</h1>

    <h3>Fetch Requests</h3>
    <form id="getAllForm" action="/getData">
        <label for="get">Get</label>
        <input type="radio" name="method" value="GET">

        <label for="head">Head</label>
        <input type="radio" name="method" value="HEAD">
        <input type="submit" value="Get JSON">
        <section id="getDataContent"></section>
    </form>

    <h3>POST: Add a book</h3> 
    <form id="addBookForm" action="/addBook" method="post">
        <label for="author">Author: </label>
        <input id="authorField" type="text" name="author">

        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title">

        <label for="year">Year: </label>
        <input id="yearField" type="number" name="year">

        <label for="genres">Genres: </label>
        <input id="genresField" type="text" name="genres">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book" />
    </form>

    <h3>POST: Add Admin Details</h3>
    <form id="adminForm" action="/addDetails" method="post">
        <label for="title">Title: </label>
        <input id="titleField" type="text" name="title" >

        <label for="page">Pages: </label>
        <input id="pageField" type="number" min="1" name="page">

        <label for="country">Country: </label>
        <input id="countryField" type="text" name="country">

        <select name="dataType" id="dataType">
            <option value="application/json">JSON</option>
            <option value="application/x-www-form-urlencoded">URL Encoded</option>
        </select>

        <input type="submit" value="Add Book">
    </form>

    <section id="content"></section>
    
</body>
</html>